name: ğŸ¤– AI-Powered Daily News Digest & Website

on:
  schedule:
    # Run daily at 5:00 AM UTC (6:00 AM BST / 5:00 AM GMT)
    # This ensures 6 AM UK time during British Summer Time
    - cron: '0 5 * * *'
  push:
    branches: [ main ]  # Trigger on main branch pushes for development
    paths:
      - 'docs/**'
      - 'scripts/**'
      - 'config/**'
      - 'requirements.txt'
      - '.github/workflows/**'
  workflow_dispatch: # Allow manual triggering
    inputs:
      debug_mode:
        description: 'Enable debug output'
        required: false
        default: false
        type: boolean
      force_ai_regeneration:
        description: 'Force AI analysis even if today content exists (costs API credits)'
        required: false
        default: false
        type: boolean
      deploy_only:
        description: 'Skip AI generation, just redeploy existing content'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-ai-digest:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      actions: read
      issues: write  # For creating issues on failures
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main  # Develop and deploy from main branch
        token: ${{ secrets.GITHUB_TOKEN }}
        lfs: true  # Enable Git LFS checkout
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
    
    - name: ğŸ“¦ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install anthropic  # AI provider for news analysis
    
    - name: ğŸ” Check if today's content exists
      id: check_content
      run: |
        TODAY=$(date +%Y_%m_%d)
        # Check for enabled languages (en_GB, pl_PL, bella)
        LANGUAGES=("en_GB" "pl_PL" "bella")
        ALL_EXIST=true
        
        for LANG in "${LANGUAGES[@]}"; do
          AUDIO_FILE="docs/${LANG}/audio/news_digest_ai_${TODAY}.mp3"
          TEXT_FILE="docs/${LANG}/news_digest_ai_${TODAY}.txt"
          
          # Check if files exist AND audio file has reasonable size (>50KB)
          if [[ -f "$AUDIO_FILE" && -f "$TEXT_FILE" ]]; then
            AUDIO_SIZE=$(stat -c%s "$AUDIO_FILE" 2>/dev/null || echo "0")
            if [[ $AUDIO_SIZE -gt 50000 ]]; then
              echo "âœ… ${LANG} content exists and valid: $AUDIO_FILE ($(numfmt --to=iec $AUDIO_SIZE)), $TEXT_FILE"
            else
              echo "âš ï¸ ${LANG} audio file too small (${AUDIO_SIZE} bytes) - needs regeneration"
              ALL_EXIST=false
            fi
          else
            echo "ğŸ“ ${LANG} content missing:"
            [[ ! -f "$AUDIO_FILE" ]] && echo "   âŒ Missing: $AUDIO_FILE"
            [[ ! -f "$TEXT_FILE" ]] && echo "   âŒ Missing: $TEXT_FILE"
            ALL_EXIST=false
          fi
        done
        
        if [[ "$ALL_EXIST" == "true" ]]; then
          echo "content_exists=true" >> $GITHUB_OUTPUT
          echo "ğŸŒ All language content exists for today"
        else
          echo "content_exists=false" >> $GITHUB_OUTPUT
          echo "ğŸŒ Some language content missing - will generate"
        fi
        
        echo "today_date=$TODAY" >> $GITHUB_OUTPUT
    
    - name: ğŸ¤– Generate AI-Enhanced News Digest
      # CRITICAL: Only run AI generation if content doesn't exist OR explicitly forced
      # This prevents unnecessary API costs on push events
      if: steps.check_content.outputs.content_exists == 'false' || inputs.force_ai_regeneration == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          echo "ğŸš€ Push-triggered build: Deploying UX improvements..."
          echo "ğŸ’° Cost optimization: Will only generate AI content if missing"
        elif [ "${{ github.event_name }}" = "schedule" ]; then
          echo "â° Scheduled build: Daily news digest generation..."
          echo "ğŸ’° This step uses API credits - content_exists: ${{ steps.check_content.outputs.content_exists }}"
        else
          echo "ğŸ”§ Manual workflow: Custom parameters applied"
          echo "ğŸ’° This step uses API credits - content_exists: ${{ steps.check_content.outputs.content_exists }}"
        fi
        # Generate content for enabled languages only (cost optimization)
        # ACTIVE: en_GB (English), pl_PL (Polish), bella (BellaNews - personalized)
        # DISABLED: fr_FR, de_DE, es_ES, it_IT, nl_NL, en_GB_LON, en_GB_LIV (cost savings)
        CORE_LANGUAGES=("en_GB" "pl_PL" "bella")  # English, Polish, and BellaNews
        NEW_LANGUAGES=()  # No new languages being tested
        FAILED_LANGUAGES=()
        SUCCESS_COUNT=0
        CORE_SUCCESS_COUNT=0
        
        # Process core languages (en_GB, pl_PL, and bella - cost optimized)
        echo "ğŸ¯ PHASE 1: Generating CORE languages (en_GB, pl_PL, and bella)"
        for LANG in "${CORE_LANGUAGES[@]}"; do
          echo "ğŸŒ Generating content for ${LANG}..."
          echo "â° Started at: $(date)"
          
          # Run with timeout and capture exit code
          set +e  # Don't exit on error
          timeout 300 python scripts/github_ai_news_digest.py --language ${LANG}
          EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          echo "â° Completed at: $(date)"
          echo "ğŸ” Exit code: ${EXIT_CODE}"
          
          # Check exit code
          if [ $EXIT_CODE -eq 124 ]; then
            echo "â° ${LANG} generation timed out after 5 minutes"
            FAILED_LANGUAGES+=("${LANG} (timeout)")
          elif [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ ${LANG} generation failed with exit code ${EXIT_CODE}"
            FAILED_LANGUAGES+=("${LANG} (exit ${EXIT_CODE})")
          else
            # Check if files were actually created
            TODAY=$(date +%Y_%m_%d)
            AUDIO_FILE="docs/${LANG}/audio/news_digest_ai_${TODAY}.mp3"
            TEXT_FILE="docs/${LANG}/news_digest_ai_${TODAY}.txt"
            
            if [[ -f "$AUDIO_FILE" && -f "$TEXT_FILE" ]]; then
              echo "âœ… ${LANG} generation successful"
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              CORE_SUCCESS_COUNT=$((CORE_SUCCESS_COUNT + 1))
            else
              echo "âš ï¸ ${LANG} generation completed but files missing"
              FAILED_LANGUAGES+=("${LANG} (no files)")
            fi
          fi
          
          echo "---"
        done
        
        # Check if core languages succeeded before proceeding
        if [ $CORE_SUCCESS_COUNT -eq ${#CORE_LANGUAGES[@]} ]; then
          echo "âœ… All core languages successful - proceeding with new languages"
          echo "ğŸ¯ PHASE 2: Generating NEW languages (optional)"
          
          for LANG in "${NEW_LANGUAGES[@]}"; do
            echo "ğŸŒ Generating content for ${LANG}..."
            echo "â° Started at: $(date)"
            
            # Run with timeout and capture exit code
            set +e  # Don't exit on error
            timeout 300 python scripts/github_ai_news_digest.py --language ${LANG}
            EXIT_CODE=$?
            set -e  # Re-enable exit on error
            
            echo "â° Completed at: $(date)"
            echo "ğŸ” Exit code: ${EXIT_CODE}"
            
            # Check exit code
            if [ $EXIT_CODE -eq 124 ]; then
              echo "â° ${LANG} generation timed out after 5 minutes"
              FAILED_LANGUAGES+=("${LANG} (timeout)")
            elif [ $EXIT_CODE -ne 0 ]; then
              echo "âŒ ${LANG} generation failed with exit code ${EXIT_CODE}"
              FAILED_LANGUAGES+=("${LANG} (exit ${EXIT_CODE})")
            else
              # Check if files were actually created
              TODAY=$(date +%Y_%m_%d)
              AUDIO_FILE="docs/${LANG}/audio/news_digest_ai_${TODAY}.mp3"
              TEXT_FILE="docs/${LANG}/news_digest_ai_${TODAY}.txt"
              
              if [[ -f "$AUDIO_FILE" && -f "$TEXT_FILE" ]]; then
                echo "âœ… ${LANG} generation successful"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                echo "âš ï¸ ${LANG} generation completed but files missing"
                FAILED_LANGUAGES+=("${LANG} (no files)")
              fi
            fi
            
            echo "---"
          done
        else
          echo "âŒ Core languages failed - skipping new languages to save time"
          for LANG in "${NEW_LANGUAGES[@]}"; do
            FAILED_LANGUAGES+=("${LANG} (skipped - core failed)")
          done
        fi
        
        # Report results
        TOTAL_LANGUAGES=$((${#CORE_LANGUAGES[@]} + ${#NEW_LANGUAGES[@]}))
        echo "ğŸ“Š GENERATION SUMMARY:"
        echo "âœ… Successful: ${SUCCESS_COUNT}/${TOTAL_LANGUAGES} languages"
        echo "âœ… Core languages: ${CORE_SUCCESS_COUNT}/${#CORE_LANGUAGES[@]} (en_GB, pl_PL, bella)"
        if [ ${#FAILED_LANGUAGES[@]} -gt 0 ]; then
          echo "âŒ Failed languages:"
          for failed in "${FAILED_LANGUAGES[@]}"; do
            echo "   - ${failed}"
          done
        fi
        
        # Require all core languages to succeed (en_GB, fr_FR, de_DE)
        if [ $CORE_SUCCESS_COUNT -eq ${#CORE_LANGUAGES[@]} ]; then
          echo "âœ… All core languages generated successfully - continuing"
        else
          echo "âŒ Core language generation failed (${CORE_SUCCESS_COUNT}/${#CORE_LANGUAGES[@]}) - failing CI"
          echo "ğŸ’¡ New languages (es_ES, it_IT, nl_NL, en_GB_LON, en_GB_LIV) are optional and won't fail CI"
          exit 1
        fi
        echo "âœ… Digest generation completed"
    
    - name: âš¡ Skip AI Generation (Cost Optimization)
      if: steps.check_content.outputs.content_exists == 'true' && inputs.force_ai_regeneration != 'true'
      run: |
        echo "ğŸ’° COST OPTIMIZATION: Skipping AI generation"
        echo "âœ… Today's content already exists: ${{ steps.check_content.outputs.today_date }}"
        echo "ğŸ“Š Estimated savings: \$0.50-\$2.00 per skip"
        echo "ğŸ’¡ Use 'force_ai_regeneration: true' to override if needed"
        if [ "${{ github.event_name }}" = "push" ]; then
          echo "ğŸš€ Push event: Deploying code improvements without regenerating content"
        elif [ "${{ github.event_name }}" = "schedule" ]; then
          echo "â° Scheduled event: Content exists, no regeneration needed"
          echo "ğŸ“» RSS feeds will still be regenerated to ensure they're up to date"
        else
          echo "ğŸ”„ Will redeploy existing content with any improvements"
        fi
    
    - name: ğŸ“Š Analyze generated content
      run: |
        TODAY=$(date +%Y_%m_%d)
        echo "ğŸ” Verifying generated content for ${TODAY}..."
        
        # Check all enabled languages
        for LANG in en_GB pl_PL bella; do
          AUDIO_FILE="docs/${LANG}/audio/news_digest_ai_${TODAY}.mp3"
          TEXT_FILE="docs/${LANG}/news_digest_ai_${TODAY}.txt"
          
          if [ -f "$AUDIO_FILE" ] && [ -f "$TEXT_FILE" ]; then
            AUDIO_SIZE=$(stat -c%s "$AUDIO_FILE" 2>/dev/null || echo "0")
            TEXT_SIZE=$(stat -c%s "$TEXT_FILE" 2>/dev/null || echo "0")
            echo "âœ… ${LANG}: audio=${AUDIO_SIZE} bytes, text=${TEXT_SIZE} bytes"
          else
            echo "âŒ ${LANG}: Missing files!"
            [ ! -f "$AUDIO_FILE" ] && echo "   Missing: $AUDIO_FILE"
            [ ! -f "$TEXT_FILE" ] && echo "   Missing: $TEXT_FILE"
          fi
        done
        
        # Legacy check for root directory (shouldn't exist but check anyway)
        if [ -f news_digest_ai_*.mp3 ]; then
          echo "âš ï¸ Audio files found in root directory (should be in language dirs)"
          ls -lh news_digest_ai_*.mp3
        fi
        if [ -f news_digest_ai_*.txt ]; then
          echo "âš ï¸ Text files found in root directory (should be in language dirs)"
          wc -w news_digest_ai_*.txt
        fi
    
    - name: ğŸŒ Update language-specific HTML pages
      # Always run this step, even if content already exists, to ensure HTML is up to date
      run: |
        echo "ğŸŒ Updating language-specific HTML pages with today's content"
        
        # Ensure Git LFS files are available (critical for newly generated files)
        echo "ğŸ”„ Ensuring Git LFS files are available..."
        git lfs pull || echo "âš ï¸ Git LFS pull failed (may continue if files already available)"
        
        # Update enabled languages (en_GB, pl_PL, bella)
        ALL_LANGUAGES=("en_GB" "pl_PL" "bella")
        
        for LANG in "${ALL_LANGUAGES[@]}"; do
          echo "ğŸ“ Updating ${LANG} page..."
          # Check if today's content exists before updating
          TODAY=$(date +%Y_%m_%d)
          AUDIO_FILE="docs/${LANG}/audio/news_digest_ai_${TODAY}.mp3"
          TEXT_FILE="docs/${LANG}/news_digest_ai_${TODAY}.txt"
          
          # Verify files exist and are actual files (not LFS pointers)
          if [ -f "$AUDIO_FILE" ] && [ -f "$TEXT_FILE" ]; then
            # Check if audio file is a real file (not LFS pointer - should be >1KB for real MP3)
            AUDIO_SIZE=$(stat -c%s "$AUDIO_FILE" 2>/dev/null || echo "0")
            if [ "$AUDIO_SIZE" -gt 1000 ]; then
              echo "âœ… Found ${LANG} content: audio=${AUDIO_SIZE} bytes"
              if python3 scripts/update_language_website.py --language ${LANG}; then
                echo "âœ… ${LANG} page updated successfully"
              else
                echo "âŒ ${LANG} page update failed - this will cause website to show old content"
                exit 1
              fi
            else
              echo "âš ï¸ ${LANG} audio file too small (${AUDIO_SIZE} bytes) - may be LFS pointer, pulling LFS..."
              git lfs pull --include="docs/${LANG}/audio/news_digest_ai_${TODAY}.mp3" || true
              # Retry after LFS pull
              if [ -f "$AUDIO_FILE" ] && [ "$(stat -c%s "$AUDIO_FILE" 2>/dev/null || echo "0")" -gt 1000 ]; then
                if python3 scripts/update_language_website.py --language ${LANG}; then
                  echo "âœ… ${LANG} page updated successfully after LFS pull"
                else
                  echo "âŒ ${LANG} page update failed after LFS pull"
                  exit 1
                fi
              else
                echo "âŒ ${LANG} content not available even after LFS pull"
                exit 1
              fi
            fi
          else
            echo "âŒ ${LANG} content for today not found:"
            [ ! -f "$AUDIO_FILE" ] && echo "   Missing: $AUDIO_FILE"
            [ ! -f "$TEXT_FILE" ] && echo "   Missing: $TEXT_FILE"
            echo "âŒ HTML update cannot proceed without content - failing workflow"
            exit 1
          fi
        done
        
        echo "âœ… Language pages update completed"
    
    - name: ğŸ“± Verify files in correct locations
      run: |
        # Check if files are in the correct language-specific directories
        # Only checking ENABLED languages (en_GB, pl_PL) to reduce log noise
        LANGUAGES=("en_GB" "pl_PL")
        
        for LANG in "${LANGUAGES[@]}"; do
          echo "ğŸ” Checking ${LANG} files..."
          
          # Check audio files
          if ls docs/${LANG}/audio/news_digest_ai_*.mp3 1> /dev/null 2>&1; then
            echo "ğŸ§ ${LANG} audio files found in correct location:"
            ls -la docs/${LANG}/audio/news_digest_ai_*.mp3
          else
            echo "âš ï¸ No ${LANG} audio files found in docs/${LANG}/audio/"
          fi
          
          # Check text files
          if ls docs/${LANG}/news_digest_ai_*.txt 1> /dev/null 2>&1; then
            echo "ğŸ“„ ${LANG} text files found in correct location:"
            ls -la docs/${LANG}/news_digest_ai_*.txt
          else
            echo "âš ï¸ No ${LANG} text files found in docs/${LANG}/"
          fi
        done
        
        # Check for any files in wrong location and move them
        if ls news_digest_ai_*.mp3 1> /dev/null 2>&1; then
          echo "ğŸ“ Moving audio files from root to en_GB..."
          mkdir -p docs/en_GB/audio
          mv news_digest_ai_*.mp3 docs/en_GB/audio/
        fi
        
        if ls news_digest_ai_*.txt 1> /dev/null 2>&1; then
          echo "ğŸ“ Moving text files from root to en_GB..."
          mv news_digest_ai_*.txt docs/en_GB/
        fi
    
    - name: ğŸ™ï¸ Generate Podcast RSS Feeds
      # Always run this step to ensure RSS feeds are always up to date with latest episodes
      run: |
        echo "ğŸ™ï¸ Generating RSS feeds for podcast distribution"
        echo "ğŸ“» This step always runs to ensure RSS feeds are current, even if content already exists"
        # Ensure Git LFS files are pulled for transcript access
        git lfs pull || echo "âš ï¸ Git LFS pull failed (may continue if files already available)"
        python scripts/generate_podcast_rss.py || {
          echo "âŒ RSS generation failed - this is critical for podcast updates"
          echo "âš ï¸ Attempting to continue, but RSS feeds may not be updated"
          exit 0
        }
        echo "âœ… RSS feeds generated successfully"
    
    - name: ğŸ” Quality check
      run: |
        # Check if files were generated in language-specific directories
        # Only checking ENABLED languages (en_GB, pl_PL, bella)
        LANGUAGES=("en_GB" "pl_PL" "bella")
        TOTAL_FILES=0
        TOTAL_SIZE=0
        
        for LANG in "${LANGUAGES[@]}"; do
          AUDIO_FILE="docs/${LANG}/audio/news_digest_ai_*.mp3"
          TEXT_FILE="docs/${LANG}/news_digest_ai_*.txt"
          
          if ls $AUDIO_FILE 1> /dev/null 2>&1; then
            # Get the first matching file (there should only be one per language per day)
            audio_file=$(ls $AUDIO_FILE | head -1)
            audio_size=$(stat -c%s "$audio_file")
            TOTAL_SIZE=$((TOTAL_SIZE + audio_size))
            TOTAL_FILES=$((TOTAL_FILES + 1))
            
            if [ $audio_size -lt 100000 ]; then
              echo "âš ï¸ ${LANG} audio file seems small: ${audio_size} bytes"
            else
              echo "âœ… ${LANG} audio file OK: ${audio_size} bytes"
            fi
          else
            echo "âš ï¸ ${LANG} audio file not found"
          fi
          
          if ls $TEXT_FILE 1> /dev/null 2>&1; then
            echo "âœ… ${LANG} text file exists"
          else
            echo "âš ï¸ ${LANG} text file not found"
          fi
        done
        
        if [ $TOTAL_FILES -eq 0 ]; then
          echo "âŒ No audio files generated in any language"
          exit 1
        fi
        
        echo "âœ… Generated $TOTAL_FILES audio files, total size: $(numfmt --to=iec $TOTAL_SIZE)"
        
        # Check if website was updated
        if [ ! -f docs/index.html ]; then
          echo "âŒ Website index.html missing"
          exit 1
        fi
        
        echo "âœ… Quality checks passed"
    
    - name: ğŸ“ Commit generated files
      run: |
        git config --local user.email "ai-digest@github.com"
        git config --local user.name "AI News Digest Bot"
        
        # CRITICAL: Check if HTML/RSS need updating BEFORE pulling (to avoid overwriting local updates)
        # This check must happen on the locally updated files, not after pulling remote
        TODAY=$(date +%Y_%m_%d)
        TODAY_FORMATTED=$(date +%Y-%m-%d)
        TODAY_ALT_FORMAT=$(date +"%B %d, %Y")
        
        HTML_NEEDS_UPDATE=false
        for LANG in en_GB pl_PL bella; do
          if [ -f "docs/${LANG}/index.html" ]; then
            # Check if HTML contains today's date in various formats
            if grep -q "$TODAY_FORMATTED\|$TODAY_ALT_FORMAT" "docs/${LANG}/index.html" 2>/dev/null; then
              echo "âœ… ${LANG} HTML page already contains today's date (local check)"
            else
              HTML_NEEDS_UPDATE=true
              echo "ğŸ“ ${LANG} HTML page needs updating for today ($TODAY_FORMATTED) - was updated locally"
            fi
          else
            HTML_NEEDS_UPDATE=true
            echo "ğŸ“ ${LANG} HTML page missing - needs creation"
          fi
        done
        
        # RSS feeds are ALWAYS regenerated in the previous step, so they may have changed
        # even if they already contain today's date (new episode added, content updated, etc.)
        # We need to check if the RSS file content actually changed, not just the date
        RSS_NEEDS_UPDATE=false
        for LANG in en_GB pl_PL bella; do
          if [ -f "docs/${LANG}/podcast.rss" ]; then
            # Check if RSS feed contains today's date - if not, definitely needs update
            if ! grep -q "<lastBuildDate>.*$(date +%d.*%b.*%Y)" "docs/${LANG}/podcast.rss" 2>/dev/null && \
               ! grep -q "<pubDate>.*$(date +%d.*%b.*%Y)" "docs/${LANG}/podcast.rss" 2>/dev/null; then
              RSS_NEEDS_UPDATE=true
              echo "ğŸ“» ${LANG} RSS feed missing today's date - needs update"
            else
              # RSS contains today's date, but it was just regenerated so it might have changed
              # We'll check if it actually changed after staging (using git diff --staged)
              echo "âœ… ${LANG} RSS feed contains today's date (was regenerated, will check for changes)"
            fi
          else
            RSS_NEEDS_UPDATE=true
            echo "ğŸ“» ${LANG} RSS feed missing - needs creation"
          fi
        done
        
        # CRITICAL: Always stage RSS feeds because they're always regenerated and may have changed
        # (new episode added, content updated, etc.) even if date is already today
        # Stage HTML and RSS files BEFORE pulling to preserve updates
        echo "ğŸ“ Staging HTML and RSS files before pull (RSS always regenerated, HTML may be updated)..."
        git add docs/en_GB/index.html docs/pl_PL/index.html docs/bella/index.html 2>/dev/null || true
        git add docs/en_GB/podcast.rss docs/pl_PL/podcast.rss docs/bella/podcast.rss 2>/dev/null || true
        
        # Pull latest changes FIRST before staging to avoid conflicts
        echo "ğŸ”„ Pulling latest changes to handle concurrent runs..."
        git pull --rebase origin main || {
          echo "âš ï¸ Pull failed, resetting and trying again..."
          git reset --hard origin/main || true
          git pull origin main || echo "âš ï¸ Pull failed, continuing anyway"
          # Re-stage HTML and RSS files after reset (RSS always regenerated, HTML may be updated)
          git add docs/en_GB/index.html docs/pl_PL/index.html docs/bella/index.html 2>/dev/null || true
          git add docs/en_GB/podcast.rss docs/pl_PL/podcast.rss docs/bella/podcast.rss 2>/dev/null || true
        }
        
        # Check if today's content already exists in remote (another workflow may have already committed)
        # Only skip if ALL languages already exist (not just some)
        ALL_LANGUAGES_EXIST=true
        for LANG in en_GB pl_PL bella; do
          if git ls-tree -r origin/main --name-only | grep -q "docs/${LANG}/audio/news_digest_ai_${TODAY}.mp3"; then
            echo "âœ… Remote already has ${LANG} content for ${TODAY}"
          else
            ALL_LANGUAGES_EXIST=false
            echo "ğŸ“ Remote missing ${LANG} content for ${TODAY} - will commit"
          fi
        done
        
        # NOTE: HTML_NEEDS_UPDATE is already set BEFORE the pull (checked on locally updated files).
        # RSS feeds are always regenerated, so we'll check if they actually changed after staging.
        # We don't re-check here because git pull might have overwritten files, but we already
        # staged them before the pull. The staging preserves our local updates through the rebase.
        
        # Check if RSS feeds actually changed (they're always regenerated, but might be identical)
        RSS_ACTUALLY_CHANGED=false
        for LANG in en_GB pl_PL bella; do
          if git diff --staged docs/${LANG}/podcast.rss 2>/dev/null | grep -q .; then
            RSS_ACTUALLY_CHANGED=true
            echo "ğŸ“» ${LANG} RSS feed has changes to commit"
          fi
        done
        
        # Only skip commit if ALL of the following are true:
        # 1. All audio files exist
        # 2. All HTML pages are up to date
        # 3. RSS feeds didn't actually change (even though they were regenerated)
        if [ "$ALL_LANGUAGES_EXIST" = "true" ] && [ "$HTML_NEEDS_UPDATE" = "false" ] && [ "$RSS_ACTUALLY_CHANGED" = "false" ]; then
          echo "ğŸ’° COST OPTIMIZATION: All content already exists and is up to date"
          echo "ğŸ“Š Another workflow may have already committed - skipping commit"
          echo "âœ… This is expected behavior for concurrent runs"
          exit 0
        fi
        
        if [ "$ALL_LANGUAGES_EXIST" = "true" ]; then
          if [ "$HTML_NEEDS_UPDATE" = "true" ] || [ "$RSS_ACTUALLY_CHANGED" = "true" ]; then
            echo "ğŸ“ Audio files exist but HTML/RSS need updating - will commit updates"
          fi
        fi
        
        # Add ONLY language-specific files to avoid conflicts
        # This prevents touching the root index.html and other development files
        git add docs/en_GB/ docs/fr_FR/ docs/de_DE/ docs/es_ES/ docs/it_IT/ docs/nl_NL/ docs/pl_PL/ docs/bella/ docs/en_GB_LON/ docs/en_GB_LIV/ || true
        
        # Explicitly add RSS feeds to ensure they're always committed when updated
        git add docs/en_GB/podcast.rss docs/pl_PL/podcast.rss docs/bella/podcast.rss 2>/dev/null || true
        
        # Explicitly add HTML pages to ensure they're always committed when updated
        git add docs/en_GB/index.html docs/pl_PL/index.html docs/bella/index.html 2>/dev/null || true
        
        # Also add any files that might be in wrong location (for backward compatibility)
        git add news_digest_ai_*.mp3 news_digest_ai_*.txt 2>/dev/null || true
        
        # Always check if RSS feeds or HTML pages were staged for commit
        RSS_UPDATED=false
        HTML_UPDATED=false
        for LANG in en_GB pl_PL bella; do
          if git diff --staged docs/${LANG}/podcast.rss 2>/dev/null | grep -q .; then
            RSS_UPDATED=true
            echo "ğŸ“» ${LANG} RSS feed has been updated and staged"
          fi
          if git diff --staged docs/${LANG}/index.html 2>/dev/null | grep -q .; then
            HTML_UPDATED=true
            echo "ğŸŒ ${LANG} HTML page has been updated and staged"
          fi
        done
        
        # Create commit with date and stats
        if git diff --staged --quiet; then
          echo "ğŸ’° COST OPTIMIZATION: No new files to commit - content already exists"
          echo "ğŸ“Š Estimated API cost savings: \$0.50-\$2.00"
          exit 0
        elif [ "$RSS_UPDATED" = "true" ] || [ "$HTML_UPDATED" = "true" ]; then
          # Commit RSS/HTML updates even if audio files already exist
          COMMIT_MSG="ğŸ¤– Daily AI news digest & website update $(date +%Y-%m-%d)

          ğŸ“Š Generated: $(date '+%Y-%m-%d %H:%M UTC')"
          if [ "$RSS_UPDATED" = "true" ]; then
            COMMIT_MSG="${COMMIT_MSG}
          ğŸ“» Podcast: RSS feeds updated"
          fi
          if [ "$HTML_UPDATED" = "true" ]; then
            COMMIT_MSG="${COMMIT_MSG}
          ğŸŒ Website: HTML pages updated"
          fi
          if [ "$ALL_LANGUAGES_EXIST" = "false" ]; then
            # Calculate audio stats if we have new audio files
            TOTAL_SIZE=0
            LANG_STATS=""
            for LANG in en_GB pl_PL bella; do
              if ls docs/${LANG}/audio/news_digest_ai_*.mp3 1> /dev/null 2>&1; then
                audio_file=$(ls docs/${LANG}/audio/news_digest_ai_*.mp3 | head -1)
                size_bytes=$(stat -c%s "$audio_file")
                size_human=$(numfmt --to=iec $size_bytes)
                TOTAL_SIZE=$((TOTAL_SIZE + size_bytes))
                LANG_STATS="${LANG_STATS}${LANG}: ${size_human} "
              fi
            done
            total_size_human=$(numfmt --to=iec $TOTAL_SIZE)
            COMMIT_MSG="${COMMIT_MSG}
          ğŸ§ Audio: ${total_size_human} total (${LANG_STATS})"
          fi
          COMMIT_MSG="${COMMIT_MSG}
          ğŸ¤– AI: Enhanced analysis
          â™¿ Accessibility: Optimized for visually impaired users"
          
          git commit -m "$COMMIT_MSG"
          
          # Push with retry logic
          MAX_PUSH_RETRIES=3
          PUSH_RETRY=0
          while [ $PUSH_RETRY -lt $MAX_PUSH_RETRIES ]; do
            if git push; then
              echo "âœ… Files committed and pushed successfully"
              break
            else
              PUSH_RETRY=$((PUSH_RETRY + 1))
              if [ $PUSH_RETRY -lt $MAX_PUSH_RETRIES ]; then
                echo "âš ï¸ Push attempt $PUSH_RETRY failed, pulling latest and retrying..."
                git fetch origin main
                git reset --hard HEAD~1
                git pull --rebase origin main || git reset --hard origin/main
                git add docs/en_GB/ docs/fr_FR/ docs/de_DE/ docs/es_ES/ docs/it_IT/ docs/nl_NL/ docs/pl_PL/ docs/bella/ docs/en_GB_LON/ docs/en_GB_LIV/ || true
                git add docs/en_GB/podcast.rss docs/pl_PL/podcast.rss docs/bella/podcast.rss 2>/dev/null || true
                git add docs/en_GB/index.html docs/pl_PL/index.html docs/bella/index.html 2>/dev/null || true
                git commit -m "$COMMIT_MSG" || echo "âš ï¸ No changes to commit after rebase"
              else
                echo "âš ï¸ Push failed after $MAX_PUSH_RETRIES attempts"
              fi
            fi
          done
        else
          # New audio files exist (and possibly RSS/HTML updates too)
          # Build commit message
          COMMIT_MSG="ğŸ¤– Daily AI news digest & website update $(date +%Y-%m-%d)

          ğŸ“Š Generated: $(date '+%Y-%m-%d %H:%M UTC')"
          
          # Add RSS/HTML update info if they were updated
          if [ "$RSS_UPDATED" = "true" ]; then
            COMMIT_MSG="${COMMIT_MSG}
          ğŸ“» Podcast: RSS feeds updated"
          fi
          if [ "$HTML_UPDATED" = "true" ]; then
            COMMIT_MSG="${COMMIT_MSG}
          ğŸŒ Website: HTML pages updated"
          fi
          
          # Calculate audio stats for new audio files
          TOTAL_SIZE=0
          LANG_STATS=""
          for LANG in en_GB pl_PL bella; do
            if ls docs/${LANG}/audio/news_digest_ai_*.mp3 1> /dev/null 2>&1; then
              audio_file=$(ls docs/${LANG}/audio/news_digest_ai_*.mp3 | head -1)
              size_bytes=$(stat -c%s "$audio_file")
              size_human=$(numfmt --to=iec $size_bytes)
              TOTAL_SIZE=$((TOTAL_SIZE + size_bytes))
              LANG_STATS="${LANG_STATS}${LANG}: ${size_human} "
            fi
          done
          total_size_human=$(numfmt --to=iec $TOTAL_SIZE)
          COMMIT_MSG="${COMMIT_MSG}
          ğŸ§ Audio: ${total_size_human} total (${LANG_STATS})
          ğŸ¤– AI: Enhanced analysis
          ğŸŒ Website: Updated with accessible newspaper layout
          â™¿ Accessibility: Optimized for visually impaired users"
          
          git commit -m "$COMMIT_MSG"
          
          # Push with retry logic for concurrent runs
          MAX_PUSH_RETRIES=3
          PUSH_RETRY=0
          while [ $PUSH_RETRY -lt $MAX_PUSH_RETRIES ]; do
            if git push; then
              echo "âœ… Files committed and pushed successfully"
              break
            else
              PUSH_RETRY=$((PUSH_RETRY + 1))
              if [ $PUSH_RETRY -lt $MAX_PUSH_RETRIES ]; then
                echo "âš ï¸ Push attempt $PUSH_RETRY failed, pulling latest and retrying..."
                # Reset to avoid merge conflicts with binary files
                git fetch origin main
                # Check if remote has the same files we're trying to push
                REMOTE_HAS_SAME=false
                for LANG in en_GB pl_PL bella; do
                  if git ls-tree -r origin/main --name-only | grep -q "docs/${LANG}/audio/news_digest_ai_${TODAY}.mp3"; then
                    REMOTE_HAS_SAME=true
                  fi
                done
                if [ "$REMOTE_HAS_SAME" = "true" ]; then
                  echo "âœ… Remote already has today's content - another workflow succeeded"
                  echo "ğŸ’° Skipping push to avoid duplicate commits"
                  exit 0
                fi
                # Reset and rebase
                git reset --hard HEAD~1
                git pull --rebase origin main || git reset --hard origin/main
                # Re-add and recommit
                git add docs/en_GB/ docs/fr_FR/ docs/de_DE/ docs/es_ES/ docs/it_IT/ docs/nl_NL/ docs/pl_PL/ docs/bella/ docs/en_GB_LON/ docs/en_GB_LIV/ || true
                git add docs/en_GB/podcast.rss docs/pl_PL/podcast.rss docs/bella/podcast.rss 2>/dev/null || true
                git add docs/en_GB/index.html docs/pl_PL/index.html docs/bella/index.html 2>/dev/null || true
                git add news_digest_ai_*.mp3 news_digest_ai_*.txt 2>/dev/null || true
                git commit -m "$COMMIT_MSG" || echo "âš ï¸ No changes to commit after rebase"
              else
                echo "âš ï¸ Push failed after $MAX_PUSH_RETRIES attempts - another workflow may have already pushed"
                echo "âœ… This is acceptable for concurrent runs"
              fi
            fi
          done
        fi
    
    - name: ğŸ“¤ Upload artifacts for download
      uses: actions/upload-artifact@v4
      with:
        name: ai-news-digest-${{ github.run_number }}
        path: |
          news_digest_ai_*.mp3
          news_digest_ai_*.txt
          docs/
        retention-days: 90
    
    - name: ğŸ·ï¸ Create release for audio file
      if: success() && (github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.force_ai_regeneration == 'true'))
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: daily-${{ steps.check_content.outputs.today_date }}
        name: ğŸ§ Daily AI News Digest - ${{ steps.check_content.outputs.today_date }}
        body: |
          ğŸ¤– **AI-Enhanced News Digest**
          ğŸ“… Generated: ${{ github.event.head_commit.timestamp }}
          
          ### ğŸ¯ Features
          - âœ… Claude 4.5 Sonnet AI analysis
          - âœ… Multi-source UK news synthesis  
          - âœ… Irish Emily Neural voice (premium quality)
          - âœ… WhatsApp-ready MP3 format
          - âœ… Copyright-compliant synthesis
          - âœ… Accessible newspaper website
          
          ### ğŸ“¥ Access Options
          - **ğŸŒ Website**: [Daily News Digest](https://audionews.uk)
          - **Audio**: `news_digest_ai_*.mp3` - Ready for WhatsApp sharing
          - **Text**: `news_digest_ai_*.txt` - Full transcript with sources
          
          Perfect for visually impaired users! ğŸ§â™¿
        draft: false
        prerelease: false
        files: |
          news_digest_ai_*.mp3
          news_digest_ai_*.txt
    
    - name: âŒ Create issue on failure
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš¨ Daily AI Digest Failed - ${new Date().toISOString().split('T')[0]}`,
            body: `### âŒ AI News Digest Generation Failed
            
            **Run**: ${context.runId}
            **Date**: ${new Date().toISOString()}
            **Workflow**: ${context.workflow}
            
            Please check the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.
            
            ### Possible Issues:
            - API key expired or missing
            - Network connectivity issues
            - News source changes
            - Audio generation failure
            - Website update failure
            
            This needs immediate attention for accessibility service continuity.`,
            labels: ['bug', 'ai-digest', 'urgent']
          })

  deploy-website:
    needs: generate-ai-digest
    runs-on: ubuntu-latest
    if: success()
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main  # Deploy from main branch
        lfs: true  # Enable Git LFS checkout
    
    - name: ğŸ“¦ Pull LFS files
      run: |
        echo "ğŸ” Checking LFS files before pull..."
        echo "Checking language-specific audio directories..."
        find docs -name "*.mp3" -type f -exec ls -lh {} \; | head -10 || echo "No audio files found"
        echo "ğŸ”„ Pulling LFS files..."
        git lfs pull
        echo "âœ… LFS files after pull:"
        echo "Sample audio files (should be >500KB each):"
        find docs -name "news_digest_ai_*.mp3" -type f -exec ls -lh {} \; | head -10
    
    - name: ğŸ”§ Setup Pages
      uses: actions/configure-pages@v5
    
    - name: ğŸ“¦ Upload Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./docs
    
    - name: ğŸš€ Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

  notify-completion:
    needs: [generate-ai-digest, deploy-website]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: ğŸ‰ Success notification
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          echo "ğŸš€ Push-triggered deployment completed successfully!"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸŒ Website deployed with UX improvements"
          echo "ğŸ’° Cost optimized: No unnecessary AI regeneration"
          echo "â™¿ Accessibility service operational"
        elif [ "${{ github.event_name }}" = "schedule" ]; then
          echo "â° Scheduled daily digest completed successfully!"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ§ Audio ready for visually impaired users"
          echo "ğŸ¤– AI analysis completed"
          echo "ğŸŒ Accessible website deployed"
          echo "â™¿ Accessibility service operational"
        else
          echo "ğŸ”§ Manual workflow completed successfully!"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ§ Audio ready for visually impaired users"
          echo "ğŸ¤– AI analysis completed"
          echo "ğŸŒ Accessible website deployed"
          echo "â™¿ Accessibility service operational"
        fi
        echo ""
        echo "ğŸ”— Website: https://audionews.uk"
